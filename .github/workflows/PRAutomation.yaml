name: PR Handler with ChatGPT

on:
  pull_request:
    types: [opened]

jobs:
  handle-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch PR base and head branches
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git fetch origin ${{ github.event.pull_request.head.ref }}

      - name: Save PR Changes to changes.txt
        run: |
          git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} > changes.txt

      - name: Generate PR title and body using ChatGPT
        id: chatgpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          CHANGES=$(head -c 5000 changes.txt | sed 's/"/\\"/g')

          JSON_PAYLOAD=$(cat <<EOF
{
  "model": "gpt-4",
  "messages": [
    {
      "role": "system",
      "content": "You are a helpful assistant that writes concise and clear GitHub pull request titles and descriptions."
    },
    {
      "role": "user",
      "content": "Generate a clear and professional pull request title and description based on the following code changes:\n\n$CHANGES"
    }
  ]
}
EOF
)

          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          echo "$RESPONSE" | jq .

          GENERATED=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          if [[ -z "$GENERATED" || "$GENERATED" == "null" ]]; then
            echo "âŒ No content returned from ChatGPT"
            exit 1
          fi

          TITLE=$(echo "$GENERATED" | head -n 1 | tr -d '\r')
          BODY=$(echo "$GENERATED" | tail -n +2)

          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "$TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update PR title and body using gh CLI
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr edit "$PR_NUMBER" \
            --title "${{ steps.chatgpt.outputs.title }}" \
            --body "${{ steps.chatgpt.outputs.body }}"
