name: PR Handler with ChatGPT

on:
  pull_request:
    types: [opened]

jobs:
  handle-pr:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the PR branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Fetch PR base and head branches
      run: |
        git fetch origin ${{ github.event.pull_request.base.ref }}
        git fetch origin ${{ github.event.pull_request.head.ref }}

    - name: Save PR Changes to changes.txt
      run: |
        git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} > changes.txt

    - name: Generate PR title and body using ChatGPT
      id: chatgpt
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        CHANGES=$(cat changes.txt)

        JSON_PAYLOAD=$(jq -n \
          --arg model "gpt-4" \
          --arg content "Generate a concise and professional GitHub pull request title and description based on the following code changes:\n\n$CHANGES" \
          '{
            model: $model,
            messages: [
              { "role": "system", "content": "You are a helpful assistant that writes concise and clear pull request titles and descriptions." },
              { "role": "user", "content": $content }
            ]
          }')

        RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $OPENAI_API_KEY" \
          -d "$JSON_PAYLOAD")

        echo "$RESPONSE" > response.json

        GENERATED=$(jq -r '.choices[0].message.content' response.json)

        TITLE=$(echo "$GENERATED" | head -n 1)
        BODY=$(echo "$GENERATED" | tail -n +2)

        echo "title<<EOF" >> $GITHUB_OUTPUT
        echo "$TITLE" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        echo "body<<EOF" >> $GITHUB_OUTPUT
        echo "$BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Update PR title and body using gh CLI
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
      run: |
        echo "Using title:"
        echo "${{ steps.chatgpt.outputs.title }}"
        echo "Using body:"
        echo "${{ steps.chatgpt.outputs.body }}"
    
        gh pr edit "$PR_NUMBER" \
          --title "${{ steps.chatgpt.outputs.title }}" \
          --body "${{ steps.chatgpt.outputs.body }}"
